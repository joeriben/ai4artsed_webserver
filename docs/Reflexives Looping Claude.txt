Reflexives Looping - Claude Sonnet Plan:

 Plan: Canvas Decision & Fork Nodes (Evaluation, Branching, Loops)                                                               
                                                                                                                                 
 Context                                                                                                                         
                                                                                                                                 
 Session 133+: Canvas workflow execution is working for linear flows (Input → Interception → Translation → Generation →          
 Collector). Now we need decision/fork nodes for conditional branching and feedback loops.                                       
                                                                                                                                 
 Current State:                                                                                                                  
 - ✅ Linear DAG execution (topological sort, no cycles)                                                                         
 - ✅ LLM nodes (Interception, Translation) with model selection                                                                 
 - ✅ Generation nodes create actual media                                                                                       
 - ✅ Collector aggregates outputs                                                                                               
 - ❌ No branching/conditional logic                                                                                             
 - ❌ No loops/feedback mechanisms                                                                                               
 - ❌ No evaluation/decision nodes                                                                                               
                                                                                                                                 
 User Goal:                                                                                                                      
 Fork/Decision nodes that can:                                                                                                   
 1. Receive input (text or media output)                                                                                         
 2. Apply evaluation criteria (e.g., fairness, creativity, equity, cultural correctness)                                         
 3. Generate commentary/feedback                                                                                                 
 4. Branch to 2+ paths, activating one based on evaluation                                                                       
 5. Enable feedback loops (e.g., comment + input → back to Interception)                                                         
 6. Display evaluation results (canvas + output stream)                                                                          
 7. Prevent infinite loops (counter/max iterations)                                                                              
                                                                                                                                 
 ---                                                                                                                             
 Pedagogical Design Question: One Node or Multiple?                                                                              
                                                                                                                                 
 User's Question: "Wäre das wohl 1 Node oder wären es mehrere - auf pädagogischer Ebene, nicht auf der Ebene technischer         
 Umsetzung?"                                                                                                                     
                                                                                                                                 
 Recommended Answer: MULTIPLE Specialized Nodes                                                                                  
                                                                                                                                 
 Rationale (Pedagogical Perspective):                                                                                            
                                                                                                                                 
 1. Clarity & Transparency:                                                                                                      
   - "Fairness Evaluation" vs. "Creativity Check" vs. "Image Quality Check"                                                      
   - Students immediately understand WHAT is being evaluated and WHY                                                             
   - Explicit criteria = explicit learning goals                                                                                 
 2. Learning Objective Mapping:                                                                                                  
   - Different criteria = different pedagogical objectives                                                                       
   - Fairness ≠ Creativity ≠ Technical Quality                                                                                   
   - Each node type corresponds to specific competency                                                                           
 3. Composability & Reusability:                                                                                                 
   - Multiple checks can be chained: Fairness → Creativity → Quality                                                             
   - Same "Fairness Check" can be used at different workflow stages                                                              
   - Mix-and-match evaluation criteria                                                                                           
 4. Explicitness Forces Reflection:                                                                                              
   - Students must consciously choose which criteria to apply                                                                    
   - No "black box" decision-making                                                                                              
   - Visible evaluation pipeline                                                                                                 
 5. Separation of Concerns:                                                                                                      
   - Evaluation logic ≠ Branching logic ≠ Display logic                                                                          
   - Each node has single, clear purpose                                                                                         
                                                                                                                                 
 ---                                                                                                                             
 Proposed Node Types                                                                                                             
                                                                                                                                 
 1. Evaluation Nodes (LLM-based judgment)                                                                                        
                                                                                                                                 
 Purpose: Evaluate input against specific criteria, produce commentary + score/decision.                                         
                                                                                                                                 
 Node Types:                                                                                                                     
 - fairness_evaluation - Bias, stereotype, representation checks                                                                 
 - creativity_evaluation - Originality, stock-photo-likeness                                                                     
 - equity_evaluation - Cultural sensitivity, representational equity                                                             
 - quality_evaluation - Technical quality, composition, clarity                                                                  
 - custom_evaluation - User-defined criteria                                                                                     
                                                                                                                                 
 Properties:                                                                                                                     
 - llmModel: Which LLM to use (same as Interception nodes)                                                                       
 - evaluationPrompt: Criteria description (e.g., "Check for gender stereotypes")                                                 
 - outputType: 'commentary' | 'score' | 'binary' | 'all'                                                                         
 - scoreRange: For numeric scores (e.g., 0-10)                                                                                   
                                                                                                                                 
 Output:                                                                                                                         
 {                                                                                                                               
   type: 'evaluation',                                                                                                           
   output: {                                                                                                                     
     commentary: "The image shows...",                                                                                           
     score: 7.5,  // Optional                                                                                                    
     binary: true,  // Optional (pass/fail)                                                                                      
     reasoning: "..."                                                                                                            
   },                                                                                                                            
   error: null                                                                                                                   
 }                                                                                                                               
                                                                                                                                 
 ---                                                                                                                             
 2. Fork/Branch Node (Conditional routing)                                                                                       
                                                                                                                                 
 Purpose: Route workflow based on evaluation result (binary/score threshold).                                                    
                                                                                                                                 
 Node Types:                                                                                                                     
 - binary_fork - Two paths: true/false (e.g., "approved" vs. "needs revision")                                                   
 - threshold_fork - Branch based on score (e.g., score >= 7 → path A, else → path B)                                             
 - multi_fork - Multiple paths based on categories (future)                                                                      
                                                                                                                                 
 Properties:                                                                                                                     
 - condition: 'binary' | 'threshold' | 'category'                                                                                
 - thresholdValue: Numeric threshold (for threshold_fork)                                                                        
 - trueLabel: Label for "true" path (e.g., "Approved")                                                                           
 - falseLabel: Label for "false" path (e.g., "Needs Revision")                                                                   
                                                                                                                                 
 Output:                                                                                                                         
 {                                                                                                                               
   type: 'fork',                                                                                                                 
   output: {                                                                                                                     
     activePath: 'true' | 'false' | 'pathA' | 'pathB',                                                                           
     reason: "Score 7.5 >= threshold 7.0",                                                                                       
     sourceValue: 7.5  // The evaluated value                                                                                    
   },                                                                                                                            
   error: null                                                                                                                   
 }                                                                                                                               
                                                                                                                                 
 Connections:                                                                                                                    
 - Input: Connects from Evaluation node (or any node with binary/numeric output)                                                 
 - Outputs: Multiple output connectors labeled "True", "False" (or custom labels)                                                
                                                                                                                                 
 ---                                                                                                                             
 3. Display Node (Canvas visualization)                                                                                          
                                                                                                                                 
 Purpose: Show evaluation commentary/results on canvas and in output stream (non-blocking).                                      
                                                                                                                                 
 Properties:                                                                                                                     
 - displayMode: 'popup' | 'inline' | 'toast'                                                                                     
 - title: Display title                                                                                                          
                                                                                                                                 
 Output:                                                                                                                         
 {                                                                                                                               
   type: 'display',                                                                                                              
   output: {                                                                                                                     
     displayedContent: "...",                                                                                                    
     timestamp: "2024-01-25T10:30:00Z"                                                                                           
   },                                                                                                                            
   error: null                                                                                                                   
 }                                                                                                                               
                                                                                                                                 
 Behavior:                                                                                                                       
 - Passes input through unchanged (non-blocking)                                                                                 
 - Triggers frontend notification/display                                                                                        
 - Logged in collector output                                                                                                    
                                                                                                                                 
 ---                                                                                                                             
 4. Loop Controller Node (Feedback mechanism)                                                                                    
                                                                                                                                 
 Purpose: Control feedback loops, prevent infinite iterations.                                                                   
                                                                                                                                 
 Properties:                                                                                                                     
 - maxIterations: Maximum loop count (default: 3)                                                                                
 - currentIteration: Counter (managed by execution engine)                                                                       
 - feedbackTargetId: Node ID to feed back into                                                                                   
 - terminationCondition: 'max_iterations' | 'evaluation_passed' | 'both'                                                         
                                                                                                                                 
 Output:                                                                                                                         
 {                                                                                                                               
   type: 'loop_controller',                                                                                                      
   output: {                                                                                                                     
     iteration: 2,                                                                                                               
     maxIterations: 3,                                                                                                           
     shouldContinue: true,                                                                                                       
     terminationReason: null | "Max iterations reached" | "Evaluation passed"                                                    
   },                                                                                                                            
   error: null                                                                                                                   
 }                                                                                                                               
                                                                                                                                 
 Execution Behavior:                                                                                                             
 - On each execution, increment counter                                                                                          
 - Check termination condition                                                                                                   
 - If continue: route to feedback target                                                                                         
 - If terminate: route to next stage (exit loop)                                                                                 
                                                                                                                                 
 ---                                                                                                                             
 Architecture Changes                                                                                                            
                                                                                                                                 
 Backend (Python)                                                                                                                
                                                                                                                                 
 File: devserver/my_app/routes/canvas_routes.py                                                                                  
                                                                                                                                 
 Changes:                                                                                                                        
                                                                                                                                 
 1. Execution Engine Enhancement (lines 360-562):                                                                                
   - Current: Sequential execution, all nodes run if dependencies met                                                            
   - New: Conditional execution - only execute nodes on active paths                                                             
 2. Fork Logic:                                                                                                                  
   - Fork nodes have multiple output paths (connections labeled)                                                                 
   - Based on evaluation result, mark one path as "active"                                                                       
   - Downstream nodes only execute if all incoming paths are active                                                              
 3. Loop Logic:                                                                                                                  
   - Track iteration count per loop                                                                                              
   - On loop controller: check termination condition                                                                             
   - If continue: add feedback target to execution queue                                                                         
   - If terminate: mark loop as exited                                                                                           
 4. Evaluation Node Execution:                                                                                                   
   - Similar to Interception nodes (LLM call via PromptInterceptionEngine)                                                       
   - Extract output_float / output_binary from response                                                                          
   - Store structured evaluation result                                                                                          
                                                                                                                                 
 Code Structure:                                                                                                                 
 # New execution state tracking                                                                                                  
 loop_counters = {}  # {loop_controller_id: iteration_count}                                                                     
 active_paths = set()  # Set of connection IDs that are active                                                                   
                                                                                                                                 
 # Execution loop modification                                                                                                   
 for node_id in execution_order:                                                                                                 
     node = node_map[node_id]                                                                                                    
     node_type = node.get('type')                                                                                                
                                                                                                                                 
     # Check if all incoming paths are active (for fork branches)                                                                
     if not all_incoming_paths_active(node_id, active_paths, incoming):                                                          
         logger.info(f"[Canvas] Skipping node {node_id} (inactive path)")                                                        
         continue                                                                                                                
                                                                                                                                 
     # Execute node based on type                                                                                                
     if node_type == 'fairness_evaluation':                                                                                      
         # Call LLM with evaluation prompt                                                                                       
         result = execute_evaluation_node(node, incoming, results)                                                               
         results[node_id] = result                                                                                               
                                                                                                                                 
     elif node_type == 'binary_fork':                                                                                            
         # Determine which path to activate                                                                                      
         source_result = get_source_result(node_id, incoming, results)                                                           
         active_path = determine_fork_path(node, source_result)                                                                  
                                                                                                                                 
         # Mark active connections                                                                                               
         for conn in outgoing[node_id]:                                                                                          
             if conn.label == active_path:                                                                                       
                 active_paths.add((node_id, conn.targetId))                                                                      
                                                                                                                                 
         results[node_id] = {                                                                                                    
             'type': 'fork',                                                                                                     
             'output': {'activePath': active_path, ...},                                                                         
             'error': None                                                                                                       
         }                                                                                                                       
                                                                                                                                 
     elif node_type == 'loop_controller':                                                                                        
         # Check iteration count                                                                                                 
         controller_id = node_id                                                                                                 
         if controller_id not in loop_counters:                                                                                  
             loop_counters[controller_id] = 0                                                                                    
                                                                                                                                 
         loop_counters[controller_id] += 1                                                                                       
         should_continue = check_loop_termination(node, loop_counters[controller_id])                                            
                                                                                                                                 
         if should_continue:                                                                                                     
             # Add feedback target to queue (re-execute)                                                                         
             feedback_target = node.get('feedbackTargetId')                                                                      
             # Re-queue execution (requires queue-based execution instead of topological)                                        
             ...                                                                                                                 
                                                                                                                                 
 ---                                                                                                                             
 Frontend (TypeScript)                                                                                                           
                                                                                                                                 
 File: public/ai4artsed-frontend/src/types/canvas.ts                                                                             
                                                                                                                                 
 New StageTypes:                                                                                                                 
 export type StageType =                                                                                                         
   | 'input'                                                                                                                     
   | 'interception'                                                                                                              
   | 'translation'                                                                                                               
   | 'generation'                                                                                                                
   | 'collector'                                                                                                                 
   // New types:                                                                                                                 
   | 'fairness_evaluation'                                                                                                       
   | 'creativity_evaluation'                                                                                                     
   | 'equity_evaluation'                                                                                                         
   | 'quality_evaluation'                                                                                                        
   | 'custom_evaluation'                                                                                                         
   | 'binary_fork'                                                                                                               
   | 'threshold_fork'                                                                                                            
   | 'display'                                                                                                                   
   | 'loop_controller'                                                                                                           
                                                                                                                                 
 New Node Properties:                                                                                                            
 export interface CanvasNode {                                                                                                   
   // ... existing properties ...                                                                                                
                                                                                                                                 
   // === Evaluation nodes ===                                                                                                   
   evaluationPrompt?: string                                                                                                     
   outputType?: 'commentary' | 'score' | 'binary' | 'all'                                                                        
   scoreRange?: { min: number; max: number }                                                                                     
                                                                                                                                 
   // === Fork nodes ===                                                                                                         
   condition?: 'binary' | 'threshold' | 'category'                                                                               
   thresholdValue?: number                                                                                                       
   trueLabel?: string                                                                                                            
   falseLabel?: string                                                                                                           
                                                                                                                                 
   // === Loop controller ===                                                                                                    
   maxIterations?: number                                                                                                        
   currentIteration?: number                                                                                                     
   feedbackTargetId?: string                                                                                                     
   terminationCondition?: 'max_iterations' | 'evaluation_passed' | 'both'                                                        
                                                                                                                                 
   // === Display ===                                                                                                            
   displayMode?: 'popup' | 'inline' | 'toast'                                                                                    
   title?: string                                                                                                                
 }                                                                                                                               
                                                                                                                                 
 New Connection Properties:                                                                                                      
 export interface CanvasConnection {                                                                                             
   sourceId: string                                                                                                              
   targetId: string                                                                                                              
   // New: Label for fork branches                                                                                               
   label?: 'true' | 'false' | 'approved' | 'rejected' | string                                                                   
   // New: Active state (for conditional execution)                                                                              
   active?: boolean                                                                                                              
 }                                                                                                                               
                                                                                                                                 
 ---                                                                                                                             
 Frontend Components                                                                                                             
                                                                                                                                 
 File: public/ai4artsed-frontend/src/components/canvas/StageModule.vue                                                           
                                                                                                                                 
 New Node Visuals:                                                                                                               
                                                                                                                                 
 1. Evaluation Nodes:                                                                                                            
   - Similar to Interception (LLM dropdown + prompt textarea)                                                                    
   - Additional: Output type selector (commentary/score/binary/all)                                                              
   - Color: #f59e0b (amber/orange for evaluation)                                                                                
 2. Fork Nodes:                                                                                                                  
   - Display condition type (binary/threshold)                                                                                   
   - Show threshold value (if applicable)                                                                                        
   - Multiple output connectors (labeled "True"/"False")                                                                         
   - Color: #ef4444 (red for decision points)                                                                                    
 3. Display Nodes:                                                                                                               
   - Title input                                                                                                                 
   - Display mode selector                                                                                                       
   - Pass-through connector (input → output)                                                                                     
   - Color: #10b981 (green for display)                                                                                          
 4. Loop Controller:                                                                                                             
   - Max iterations input                                                                                                        
   - Feedback target selector (dropdown of available nodes)                                                                      
   - Iteration counter display (during execution)                                                                                
   - Color: #6366f1 (indigo for control flow)                                                                                    
                                                                                                                                 
 Output Connector Enhancement:                                                                                                   
 <!-- Multiple output connectors for fork nodes -->                                                                              
 <div v-if="isFork" class="fork-outputs">                                                                                        
   <div class="connector output output-true" @mousedown.stop="emit('start-connect', 'true')">                                    
     <span class="connector-label">{{ node.trueLabel || 'True' }}</span>                                                         
   </div>                                                                                                                        
   <div class="connector output output-false" @mousedown.stop="emit('start-connect', 'false')">                                  
     <span class="connector-label">{{ node.falseLabel || 'False' }}</span>                                                       
   </div>                                                                                                                        
 </div>                                                                                                                          
                                                                                                                                 
 ---                                                                                                                             
 Implementation Phases                                                                                                           
                                                                                                                                 
 Phase 1: Evaluation Nodes (No Branching Yet)                                                                                    
                                                                                                                                 
 Goal: Add evaluation nodes that produce commentary/scores.                                                                      
                                                                                                                                 
 Steps:                                                                                                                          
 1. Add fairness_evaluation node type to types/canvas.ts                                                                         
 2. Add node type definition (palette, color, icon)                                                                              
 3. Implement UI for evaluation config (LLM, prompt, output type)                                                                
 4. Backend: Execute evaluation via PromptInterceptionEngine                                                                     
 5. Extract output_float, output_binary, output_str from response                                                                
 6. Display evaluation results in Collector                                                                                      
                                                                                                                                 
 Testing: Input → Interception → Fairness Evaluation → Collector                                                                 
                                                                                                                                 
 ---                                                                                                                             
 Phase 2: Display Nodes                                                                                                          
                                                                                                                                 
 Goal: Visualize evaluation results on canvas.                                                                                   
                                                                                                                                 
 Steps:                                                                                                                          
 1. Add display node type                                                                                                        
 2. Implement pass-through execution (non-blocking)                                                                              
 3. Backend: Return display data in execution results                                                                            
 4. Frontend: Show toast/popup/inline display during execution                                                                   
 5. Log displayed content in Collector                                                                                           
                                                                                                                                 
 Testing: Input → Evaluation → Display → Collector                                                                               
                                                                                                                                 
 ---                                                                                                                             
 Phase 3: Binary Fork (No Loops)                                                                                                 
                                                                                                                                 
 Goal: Conditional branching based on evaluation.                                                                                
                                                                                                                                 
 Steps:                                                                                                                          
 1. Add binary_fork node type                                                                                                    
 2. Implement multiple output connectors (labeled "True"/"False")                                                                
 3. Backend: Determine active path based on evaluation result                                                                    
 4. Implement conditional execution (skip inactive branches)                                                                     
 5. Test: Evaluation → Fork → [Path A | Path B] → Collector                                                                      
                                                                                                                                 
 Testing:                                                                                                                        
 - Input → Evaluation → Fork → (True: Gen1, False: Gen2) → Collector                                                             
 - Verify only one generation runs based on evaluation                                                                           
                                                                                                                                 
 ---                                                                                                                             
 Phase 4: Loop Controller                                                                                                        
                                                                                                                                 
 Goal: Feedback loops with iteration limits.                                                                                     
                                                                                                                                 
 Steps:                                                                                                                          
 1. Add loop_controller node type                                                                                                
 2. Implement feedback target selection UI                                                                                       
 3. Backend: Track loop counters, check termination                                                                              
 4. Modify execution engine to support re-queueing nodes                                                                         
 5. Test: Input → Evaluation → Loop Controller → (continue: back to Interception, exit: Collector)                               
                                                                                                                                 
 Testing:                                                                                                                        
 - Input → Interception → Generation → Quality Evaluation → Loop Controller                                                      
   - If quality < 7: feedback to Interception with commentary                                                                    
   - If quality >= 7: exit to Collector                                                                                          
   - Max 3 iterations                                                                                                            
                                                                                                                                 
 ---                                                                                                                             
 Phase 5: Additional Evaluation Types                                                                                            
                                                                                                                                 
 Goal: Expand evaluation criteria.                                                                                               
                                                                                                                                 
 Steps:                                                                                                                          
 1. Add creativity_evaluation, equity_evaluation, quality_evaluation nodes                                                       
 2. Implement specialized prompts for each type                                                                                  
 3. Test combinations: Fairness → Creativity → Quality → Fork                                                                    
                                                                                                                                 
 ---                                                                                                                             
 Critical Files to Modify                                                                                                        
 ┌───────┬──────────────────────────────────────────────┬──────────────────────────────────────────┐                             
 │ Phase │                     File                     │                  Change                  │                             
 ├───────┼──────────────────────────────────────────────┼──────────────────────────────────────────┤                             
 │ 1     │ public/.../types/canvas.ts                   │ Add evaluation node types                │                             
 ├───────┼──────────────────────────────────────────────┼──────────────────────────────────────────┤                             
 │ 1     │ public/.../types/canvas.ts                   │ Add NODE_TYPE_DEFINITIONS for evaluation │                             
 ├───────┼──────────────────────────────────────────────┼──────────────────────────────────────────┤                             
 │ 1     │ public/.../components/canvas/StageModule.vue │ Evaluation node UI                       │                             
 ├───────┼──────────────────────────────────────────────┼──────────────────────────────────────────┤                             
 │ 1     │ devserver/my_app/routes/canvas_routes.py     │ Execute evaluation nodes                 │                             
 ├───────┼──────────────────────────────────────────────┼──────────────────────────────────────────┤                             
 │ 2     │ public/.../types/canvas.ts                   │ Add display node type                    │                             
 ├───────┼──────────────────────────────────────────────┼──────────────────────────────────────────┤                             
 │ 2     │ public/.../components/canvas/StageModule.vue │ Display node UI                          │                             
 ├───────┼──────────────────────────────────────────────┼──────────────────────────────────────────┤                             
 │ 2     │ devserver/my_app/routes/canvas_routes.py     │ Display node execution                   │                             
 ├───────┼──────────────────────────────────────────────┼──────────────────────────────────────────┤                             
 │ 3     │ public/.../types/canvas.ts                   │ Add fork node types + connection labels  │                             
 ├───────┼──────────────────────────────────────────────┼──────────────────────────────────────────┤                             
 │ 3     │ public/.../components/canvas/StageModule.vue │ Multiple output connectors               │                             
 ├───────┼──────────────────────────────────────────────┼──────────────────────────────────────────┤                             
 │ 3     │ devserver/my_app/routes/canvas_routes.py     │ Conditional execution logic              │                             
 ├───────┼──────────────────────────────────────────────┼──────────────────────────────────────────┤                             
 │ 4     │ public/.../types/canvas.ts                   │ Add loop_controller node type            │                             
 ├───────┼──────────────────────────────────────────────┼──────────────────────────────────────────┤                             
 │ 4     │ public/.../components/canvas/StageModule.vue │ Loop controller UI                       │                             
 ├───────┼──────────────────────────────────────────────┼──────────────────────────────────────────┤                             
 │ 4     │ devserver/my_app/routes/canvas_routes.py     │ Loop execution + re-queueing             │                             
 └───────┴──────────────────────────────────────────────┴──────────────────────────────────────────┘                             
 ---                                                                                                                             
 Example Workflows                                                                                                               
                                                                                                                                 
 Workflow 1: Fairness Check with Feedback Loop                                                                                   
                                                                                                                                 
 Input ("A photo of a nurse")                                                                                                    
   ↓                                                                                                                             
 Interception (Add pedagogical context)                                                                                          
   ↓                                                                                                                             
 Generation (Create image)                                                                                                       
   ↓                                                                                                                             
 Fairness Evaluation (Check for gender stereotypes)                                                                              
   ↓                                                                                                                             
 Binary Fork                                                                                                                     
   ├─ True (Fair) → Collector                                                                                                    
   └─ False (Unfair) → Loop Controller                                                                                           
                         ↓                                                                                                       
                     Back to Interception                                                                                        
                     (with fairness commentary as context)                                                                       
                                                                                                                                 
 Behavior:                                                                                                                       
 - Generate image                                                                                                                
 - Evaluate: "Does this reinforce stereotypes?"                                                                                  
 - If fair: done                                                                                                                 
 - If unfair: add commentary like "Avoid gender stereotypes in healthcare professions" and regenerate                            
 - Max 3 iterations                                                                                                              
                                                                                                                                 
 ---                                                                                                                             
 Workflow 2: Multi-Criteria Evaluation Pipeline                                                                                  
                                                                                                                                 
 Input                                                                                                                           
   ↓                                                                                                                             
 Interception                                                                                                                    
   ↓                                                                                                                             
 Generation                                                                                                                      
   ↓                                                                                                                             
 Fairness Evaluation → Display ("Fairness Score: 8/10")                                                                          
   ↓                                                                                                                             
 Creativity Evaluation → Display ("Originality: 6/10 - Stock photo-like")                                                        
   ↓                                                                                                                             
 Quality Evaluation → Display ("Technical Quality: 9/10")                                                                        
   ↓                                                                                                                             
 Threshold Fork (Overall score >= 7?)                                                                                            
   ├─ True → Collector                                                                                                           
   └─ False → Loop Controller → Back to Interception                                                                             
                                                                                                                                 
 Behavior:                                                                                                                       
 - Chain multiple evaluations                                                                                                    
 - Display each result on canvas (transparency)                                                                                  
 - Overall decision based on combined criteria                                                                                   
 - Feedback loop if any criterion fails                                                                                          
                                                                                                                                 
 ---                                                                                                                             
 Technical Challenges & Solutions                                                                                                
                                                                                                                                 
 Challenge 1: Topological Sort with Loops                                                                                        
                                                                                                                                 
 Problem: Current execution uses Kahn's algorithm which rejects cycles.                                                          
                                                                                                                                 
 Solution:                                                                                                                       
 - Keep topological sort for initial execution order                                                                             
 - Loop Controller adds nodes back to execution queue                                                                            
 - Track visited nodes per iteration (avoid infinite loops within one iteration)                                                 
 - Use max iteration counter as hard limit                                                                                       
                                                                                                                                 
 Challenge 2: Conditional Execution (Inactive Branches)                                                                          
                                                                                                                                 
 Problem: Current system executes all nodes with satisfied dependencies.                                                         
                                                                                                                                 
 Solution:                                                                                                                       
 - Track active paths: Set<(sourceId, targetId)>                                                                                 
 - Fork node marks one outgoing path as active                                                                                   
 - Before executing node: check if ALL incoming connections are active                                                           
 - Skip execution if any incoming path is inactive                                                                               
                                                                                                                                 
 Challenge 3: Multiple Output Connectors (UI)                                                                                    
                                                                                                                                 
 Problem: Current node design has 1 output connector.                                                                            
                                                                                                                                 
 Solution:                                                                                                                       
 - Fork nodes: Render multiple connectors with labels                                                                            
 - Connection creation: Include label parameter (which output was clicked)                                                       
 - Backend: Match connection labels to fork decision (true/false)                                                                
                                                                                                                                 
 Challenge 4: LLM Response Format for Evaluations                                                                                
                                                                                                                                 
 Problem: PromptInterceptionEngine returns output_str, output_float, output_binary, output_int.                                  
                                                                                                                                 
 Solution:                                                                                                                       
 - Evaluation prompt instructs LLM to return structured response                                                                 
 - Example prompt suffix: "Return your evaluation as: SCORE: [0-10], BINARY: [true/false], COMMENTARY: [explanation]"            
 - Parse response to extract fields                                                                                              
 - Store in evaluation result                                                                                                    
                                                                                                                                 
 Alternative: Use task_instruction parameter of PromptInterceptionEngine to enforce JSON output.                                 
                                                                                                                                 
 ---                                                                                                                             
 Verification & Testing                                                                                                          
                                                                                                                                 
 Phase 1 Tests:                                                                                                                  
                                                                                                                                 
 1. Create workflow: Input → Fairness Evaluation → Collector                                                                     
 2. Check Collector shows: { commentary: "...", score: 7.5, binary: true }                                                       
 3. Verify LLM model selection works                                                                                             
 4. Test different evaluation prompts                                                                                            
                                                                                                                                 
 Phase 2 Tests:                                                                                                                  
                                                                                                                                 
 1. Add Display node after Evaluation                                                                                            
 2. Check frontend shows toast/popup with commentary                                                                             
 3. Verify execution continues (non-blocking)                                                                                    
                                                                                                                                 
 Phase 3 Tests:                                                                                                                  
                                                                                                                                 
 1. Create fork workflow: Input → Evaluation → Fork → [Gen1 (True) | Gen2 (False)] → Collector                                   
 2. Test with evaluation that returns true → verify only Gen1 runs                                                               
 3. Test with evaluation that returns false → verify only Gen2 runs                                                              
 4. Check Collector shows only active path result                                                                                
                                                                                                                                 
 Phase 4 Tests:                                                                                                                  
                                                                                                                                 
 1. Create loop workflow: Input → Interception → Gen → Quality Eval → Loop Controller (feedback to Interception)                 
 2. Test with quality < threshold → verify loop iterates max 3 times                                                             
 3. Test with quality >= threshold → verify loop exits immediately                                                               
 4. Check Collector shows all iterations                                                                                         
                                                                                                                                 
 Integration Tests:                                                                                                              
                                                                                                                                 
 1. Multi-criteria pipeline (Fairness → Creativity → Quality)                                                                    
 2. Nested loops (evaluation inside evaluation)                                                                                  
 3. Parallel evaluations (fan-out to multiple eval nodes)                                                                        
                                                                                                                                 
 ---                                                                                                                             
 UI/UX Considerations                                                                                                            
                                                                                                                                 
 Visual Clarity:                                                                                                                 
                                                                                                                                 
 - Color coding: Evaluation (amber), Fork (red), Display (green), Loop (indigo)                                                  
 - Icons: 🎯 (evaluation), 🔀 (fork), 📺 (display), 🔄 (loop)                                                                    
 - Connection labels: Show "True"/"False" on fork connections                                                                    
 - Iteration counter: Display on Loop Controller during execution                                                                
                                                                                                                                 
 User Guidance:                                                                                                                  
                                                                                                                                 
 - Palette tooltips: Explain each evaluation type                                                                                
 - Example prompts: Pre-fill evaluation prompts with examples                                                                    
   - Fairness: "Check for stereotypes, bias, and fair representation"                                                            
   - Creativity: "Evaluate originality. Avoid stock photo aesthetics."                                                           
 - Validation: Require evaluation nodes to have LLM selected                                                                     
                                                                                                                                 
 Execution Feedback:                                                                                                             
                                                                                                                                 
 - Progress indicator: Show which iteration is running                                                                           
 - Path highlight: Visually highlight active path on canvas (green glow on active connections)                                   
 - Evaluation results: Display in-node badge with score/binary result                                                            
                                                                                                                                 
 ---                                                                                                                             
 Future Enhancements (Out of Scope for Initial Implementation)                                                                   
                                                                                                                                 
 1. Multi-Fork: More than 2 paths (categorical branching)                                                                        
 2. Parallel Loops: Multiple feedback loops running concurrently                                                                 
 3. Conditional Termination: Loop exits based on evaluation result (not just max iterations)                                     
 4. Evaluation Templates: Pre-defined evaluation criteria library                                                                
 5. Composite Evaluations: Combine multiple criteria with weights                                                                
 6. Historical Comparison: Compare current iteration vs. previous iterations                                                     
 7. User Approval Node: Manual human-in-the-loop decision point                                                                  
 8. A/B Testing Node: Run both paths, compare results                                                                            
                                                                                                                                 
 ---                                                                                                                             
 Commit Strategy                                                                                                                 
                                                                                                                                 
 # Phase 1: Evaluation Nodes                                                                                                     
 git commit -m "feat(session-134): Add Fairness Evaluation node type"                                                            
 git commit -m "feat(session-134): Implement evaluation node execution"                                                          
                                                                                                                                 
 # Phase 2: Display Nodes                                                                                                        
 git commit -m "feat(session-134): Add Display node for evaluation results"                                                      
                                                                                                                                 
 # Phase 3: Fork Nodes                                                                                                           
 git commit -m "feat(session-134): Add Binary Fork node with conditional execution"                                              
                                                                                                                                 
 # Phase 4: Loop Controller                                                                                                      
 git commit -m "feat(session-134): Implement Loop Controller with feedback mechanism"                                            
                                                                                                                                 
 # Phase 5: Additional Evaluations                                                                                               
 git commit -m "feat(session-134): Add Creativity, Equity, Quality evaluation nodes"                                             
                                                                                                                                 
 ---                                                                                                                             
 Summary: Pedagogical Design Decision                                                                                            
                                                                                                                                 
 Answer to User's Question:                                                                                                      
                                                                                                                                 
 ✅ MULTIPLE specialized nodes (not one generic "Decision Node")                                                                 
                                                                                                                                 
 Why:                                                                                                                            
 1. Explicit Learning Objectives: "Fairness" vs. "Creativity" are distinct competencies                                          
 2. Transparency: Students see WHAT is evaluated at each step                                                                    
 3. Composability: Chain multiple evaluations (Fairness → Creativity → Quality)                                                  
 4. Reusability: Use same "Fairness Check" at different workflow stages                                                          
 5. Forced Reflection: Students must consciously choose criteria                                                                 
                                                                                                                                 
 Node Architecture:                                                                                                              
 - Evaluation Nodes: LLM-based judgment (fairness, creativity, equity, quality, custom)                                          
 - Fork Nodes: Conditional routing based on evaluation result                                                                    
 - Display Nodes: Visualize evaluation commentary/scores                                                                         
 - Loop Controller: Feedback mechanism with iteration limits                                                                     
                                                                                                                                 
 Separation of Concerns:                                                                                                         
 - Evaluation ≠ Branching ≠ Display ≠ Loop Control                                                                               
 - Each node type has single, pedagogically clear purpose                                                                        
 - Combine nodes to create complex, transparent evaluation pipelines   
