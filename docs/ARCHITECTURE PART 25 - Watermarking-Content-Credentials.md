# ARCHITECTURE PART 25 - Watermarking & Content Credentials

## Overview

AI4ArtsEd implements two layers of provenance tracking for generated images:

1. **Invisible Watermark** - DWT-DCT embedded text (active, automatic)
2. **C2PA Content Credentials** - Cryptographic manifest (ready, needs CA certificates)

## Quick Start

### For Users: Nothing to Do!

Watermarking is **fully automatic**. Every image generated through the pipeline will have "AI4ArtsEd" invisibly embedded.

### For New Installations

```bash
# 1. Install dependencies (one-time)
pip install invisible-watermark opencv-python c2pa-python cryptography

# 2. That's it! Watermarking works immediately.
# C2PA requires additional certificate setup (see below)
```

## Architecture

### Data Flow

```
Image Generated (SwarmUI/ComfyUI)
         │
         ▼
┌─────────────────────────────────┐
│   pipeline_recorder.py          │
│   _write_file()                 │
│                                 │
│   1. Apply watermark (bytes)    │  ◄── ENABLE_WATERMARK
│   2. Write to disk              │
│   3. Sign with C2PA (file)      │  ◄── ENABLE_C2PA
└─────────────────────────────────┘
         │
         ▼
    Saved Image (with provenance)
```

### Service Initialization (Lazy Loading)

Services are initialized on first use, not at startup:

```python
# pipeline_recorder.py
_watermark_service = None  # Lazy loaded

def _get_watermark_service():
    global _watermark_service
    if _watermark_service is None:
        if config.ENABLE_WATERMARK:
            _watermark_service = WatermarkService(config.WATERMARK_TEXT)
    return _watermark_service
```

**Benefits:**
- No startup delay if features disabled
- Graceful fallback if dependencies missing
- Config changes take effect on next image

## Configuration

### Location: `devserver/config.py`

```python
# Invisible Watermark (works immediately)
ENABLE_WATERMARK = True              # Toggle watermarking
WATERMARK_TEXT = "AI4ArtsEd"         # Text to embed (max ~32 bytes)

# C2PA Content Credentials (requires certificates)
ENABLE_C2PA = False                  # Toggle C2PA signing
C2PA_CERT_PATH = Path(__file__).parent / "certs" / "c2pa_cert.pem"
C2PA_KEY_PATH = Path(__file__).parent / "certs" / "c2pa_key.key"
C2PA_GENERATOR_NAME = "AI4ArtsEd DevServer"
C2PA_TSA_URL = "http://timestamp.digicert.com"
```

### Per-Installation Customization

Each installation can customize:

| Setting | Purpose | Example |
|---------|---------|---------|
| `WATERMARK_TEXT` | Institution identifier | `"SchuleXY-AI4ArtsEd"` |
| `C2PA_GENERATOR_NAME` | Visible in C2PA verification | `"Schule XY DevServer"` |
| `C2PA_CERT_PATH` | Custom certificate location | `/etc/ai4artsed/cert.pem` |

## Invisible Watermark Details

### Technology: DWT-DCT

The `invisible-watermark` library uses Discrete Wavelet Transform + Discrete Cosine Transform:

```
Original Image
     │
     ▼
┌─────────────┐
│ DWT         │  Split into frequency subbands
│ (Wavelet)   │  LL, LH, HL, HH
└─────────────┘
     │
     ▼
┌─────────────┐
│ DCT         │  Transform LL subband
│ (Cosine)    │  to frequency domain
└─────────────┘
     │
     ▼
┌─────────────┐
│ Embed       │  Modify DCT coefficients
│ Watermark   │  with message bits
└─────────────┘
     │
     ▼
┌─────────────┐
│ Inverse     │  Reconstruct image
│ DWT + DCT   │
└─────────────┘
     │
     ▼
Watermarked Image
```

### Robustness

| Attack | Survives? | Notes |
|--------|-----------|-------|
| JPEG Compression | ✅ | Up to Q=70 |
| Noise Addition | ✅ | Gaussian noise |
| Brightness Change | ✅ | ±20% |
| Resize | ⚠️ | May fail |
| Crop | ⚠️ | May fail |
| Rotation | ❌ | Breaks watermark |

### Limitations

- **Homogeneous images**: Solid colors, simple gradients may not embed reliably
- **Small images**: Minimum ~256x256 recommended
- **Text-heavy images**: Screenshots may have issues

AI-generated images (SD, FLUX) have excellent texture for reliable embedding.

### Verification

```python
from my_app.services.watermark_service import WatermarkService

# Check if image has our watermark
service = WatermarkService("AI4ArtsEd")
extracted = service.extract_watermark(image_bytes)

if extracted == "AI4ArtsEd":
    print("Image was generated by AI4ArtsEd")
else:
    print("No valid watermark found")
```

## C2PA Content Credentials

### What is C2PA?

Coalition for Content Provenance and Authenticity - an industry standard (Adobe, Google, Microsoft, BBC, etc.) for cryptographically signed media provenance.

### Our Manifest Structure

```json
{
  "claim_generator": "AI4ArtsEd DevServer",
  "assertions": [
    {
      "label": "c2pa.actions",
      "data": {
        "actions": [{
          "action": "c2pa.created",
          "digitalSourceType": "trainedAlgorithmicMedia",
          "softwareAgent": "AI4ArtsEd DevServer"
        }]
      }
    },
    {
      "label": "c2pa.training-mining",
      "data": {
        "entries": {
          "c2pa.ai_generative_training": {"use": "notAllowed"},
          "c2pa.ai_inference": {"use": "notAllowed"},
          "c2pa.ai_training": {"use": "notAllowed"},
          "c2pa.data_mining": {"use": "notAllowed"}
        }
      }
    }
  ]
}
```

### Certificate Requirements

**Critical:** C2PA does NOT allow self-signed certificates!

| Certificate Type | Works? | Notes |
|-----------------|--------|-------|
| Self-signed | ❌ | Explicitly prohibited by spec |
| CA-signed (any) | ⚠️ | Must be C2PA-recognized CA |
| Test fixtures | ✅ | From c2pa-python repo (dev only) |
| Production CA | ✅ | Required for public verification |

### Setting Up C2PA (Production)

1. **Obtain Certificate** from a C2PA-recognized CA:
   - [DigiCert](https://www.digicert.com/)
   - [GlobalSign](https://www.globalsign.com/)
   - Others in the C2PA trust list

2. **Install Certificate:**
   ```bash
   # Place files in devserver/certs/
   cp your_cert.pem devserver/certs/c2pa_cert.pem
   cp your_key.pem devserver/certs/c2pa_key.key  # .key in .gitignore
   ```

3. **Enable in Config:**
   ```python
   ENABLE_C2PA = True
   ```

4. **Verify:** Upload generated image to https://verify.contentcredentials.org/

### Setting Up C2PA (Development/Testing)

Use test certificates from c2pa-python:

```bash
# Download test fixtures
git clone https://github.com/contentauth/c2pa-python.git
cp c2pa-python/tests/fixtures/certs/es256_certs.pem devserver/certs/c2pa_cert.pem
cp c2pa-python/tests/fixtures/certs/es256_private.key devserver/certs/c2pa_key.key
```

Note: Test certs will show "Issuer not recognized" in verification tools.

## File Structure

```
devserver/
├── config.py                         # Configuration
├── certs/                            # Certificate storage
│   ├── c2pa_cert.pem                # Certificate (can be committed)
│   └── c2pa_key.key                 # Private key (in .gitignore!)
└── my_app/
    └── services/
        ├── watermark_service.py     # Watermark embedding/extraction
        ├── c2pa_service.py          # C2PA manifest signing
        └── pipeline_recorder.py     # Integration point
```

## API Reference

### WatermarkService

```python
class WatermarkService:
    def __init__(self, watermark_text: str = "AI4ArtsEd")
    def embed_watermark(self, image_bytes: bytes, method: str = 'dwtDct') -> bytes
    def extract_watermark(self, image_bytes: bytes, method: str = 'dwtDct') -> str | None
    def verify_watermark(self, image_bytes: bytes) -> bool
```

### C2PAService

```python
class C2PAService:
    def __init__(self, cert_path: Path, key_path: Path,
                 generator_name: str = "AI4ArtsEd DevServer",
                 tsa_url: str | None = "http://timestamp.digicert.com")
    def sign_image(self, input_path: Path, output_path: Path = None) -> Path
    def read_manifest(self, image_path: Path) -> dict | None
    def verify_image(self, image_path: Path) -> bool
```

## Troubleshooting

### Watermark Not Extracted

1. **Check image type**: Solid colors/simple gradients won't work
2. **Check image size**: Minimum 256x256 recommended
3. **Check compression**: Heavy JPEG compression may destroy watermark

### C2PA Signing Fails

1. **"Certificate was self-signed"**: Use proper CA certificate
2. **Certificate not found**: Check `C2PA_CERT_PATH` and `C2PA_KEY_PATH`
3. **TSA timeout**: Set `C2PA_TSA_URL = None` to disable timestamping

### Dependencies Missing

```bash
# Install all required packages
pip install invisible-watermark opencv-python c2pa-python cryptography
```

## Security Considerations

1. **Private keys**: Always in `.gitignore`, never commit
2. **Watermark text**: Not secret, can be extracted by anyone with the library
3. **C2PA certificates**: Production certs should be in secure storage (HSM recommended)

## Future Enhancements

- [ ] Per-user watermark text option
- [ ] Watermark strength configuration
- [ ] C2PA ingredient chain (link to source images)
- [ ] Batch verification endpoint
- [ ] Admin UI for certificate management
