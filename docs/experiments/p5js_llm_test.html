<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>p5.js LLM Test - AI4ArtsEd Validation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: #2d3748;
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.8;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .section {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .section h2 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 600;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            font-family: 'Monaco', 'Courier New', monospace;
            resize: vertical;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #48bb78;
        }

        .btn-secondary:hover {
            background: #38a169;
        }

        #codeOutput {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #preview {
            width: 100%;
            height: 620px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            background: white;
        }

        .error {
            background: #fed7d7;
            color: #9b2c2c;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .api-key-info {
            background: #fefcbf;
            border: 1px solid #f6e05e;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #ffffff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé® p5.js LLM Test Environment</h1>
            <p>Phase 0: Validation - Testing LLM-based p5.js code generation</p>
        </header>

        <div class="content">
            <!-- Left Column: Input & Configuration -->
            <div>
                <div class="section">
                    <h2>üîë OpenRouter Configuration</h2>
                    <div class="api-key-info">
                        Your API key is stored locally in your browser (localStorage). It never leaves your machine.
                    </div>
                    <div class="form-group">
                        <label for="apiKey">OpenRouter API Key:</label>
                        <input type="text" id="apiKey" placeholder="sk-or-v1-...">
                    </div>
                    <div class="form-group">
                        <label for="model">Model:</label>
                        <select id="model">
                            <option value="anthropic/claude-sonnet-4.5">Claude Sonnet 4.5</option>
                            <option value="google/gemini-pro-1.5">Gemini 1.5 Pro</option>
                        </select>
                    </div>
                </div>

                <div class="section">
                    <h2>üìù Scene Description</h2>
                    <div class="form-group">
                        <label for="scenePrompt">User Prompt:</label>
                        <textarea id="scenePrompt" rows="4" placeholder="A house stands in a landscape, surrounded by agricultural areas, nature and animals. Some people can be seen.">A house stands in a landscape, surrounded by agricultural areas, nature and animals. Some people can be seen.</textarea>
                    </div>
                </div>

                <div class="section">
                    <h2>‚öôÔ∏è System Prompt (Meta-Prompt)</h2>
                    <div class="form-group">
                        <textarea id="systemPrompt" rows="10">You are a p5.js creative coding assistant.
Generate a complete p5.js sketch that can run in the browser with the standard p5.js library.
Requirements:
‚Äì Use function setup() and function draw()
‚Äì Call createCanvas(800, 600) in setup()
‚Äì Do not use external images or fonts.
‚Äì Use only primitive shapes (rect, ellipse, line, etc.) and color.
‚Äì Represent depth with size and vertical position (larger/closer, smaller/farther).
‚Äì Include comments to map parts of the code to the scene description.
‚Äì Output only JavaScript code, no markdown, no explanation.</textarea>
                    </div>
                    <button id="generateBtn">‚ú® Generate p5.js Code</button>
                    <div id="error" class="error"></div>
                </div>
            </div>

            <!-- Right Column: Output & Preview -->
            <div>
                <div class="section">
                    <h2>üíª Generated Code</h2>
                    <div id="codeOutput">// Generated p5.js code will appear here...</div>
                    <div class="button-group">
                        <button id="runBtn" class="btn-secondary" disabled>‚ñ∂Ô∏è Run Code</button>
                        <button id="copyBtn" disabled>üìã Copy to Clipboard</button>
                    </div>
                </div>

                <div class="section">
                    <h2>üé¨ Live Preview</h2>
                    <iframe id="preview" sandbox="allow-scripts"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        const state = {
            apiKey: localStorage.getItem('openrouter_api_key') || '',
            generatedCode: null
        };

        // DOM elements
        const apiKeyInput = document.getElementById('apiKey');
        const modelSelect = document.getElementById('model');
        const scenePromptInput = document.getElementById('scenePrompt');
        const systemPromptInput = document.getElementById('systemPrompt');
        const generateBtn = document.getElementById('generateBtn');
        const runBtn = document.getElementById('runBtn');
        const copyBtn = document.getElementById('copyBtn');
        const codeOutput = document.getElementById('codeOutput');
        const preview = document.getElementById('preview');
        const errorDiv = document.getElementById('error');

        // Initialize
        apiKeyInput.value = state.apiKey;

        // Try to load API key from local file (if served from same origin)
        fetch('/devserver/openrouter.key')
            .then(r => r.text())
            .then(key => {
                if (key && !state.apiKey) {
                    state.apiKey = key.trim();
                    apiKeyInput.value = state.apiKey;
                    localStorage.setItem('openrouter_api_key', state.apiKey);
                }
            })
            .catch(() => {
                // Key file not accessible, user must enter manually
            });

        // Event listeners
        apiKeyInput.addEventListener('input', (e) => {
            state.apiKey = e.target.value;
            localStorage.setItem('openrouter_api_key', e.target.value);
        });

        generateBtn.addEventListener('click', generateCode);
        runBtn.addEventListener('click', runCode);
        copyBtn.addEventListener('click', copyToClipboard);

        // Main functions
        async function generateCode() {
            if (!state.apiKey) {
                showError('Please enter your OpenRouter API key');
                return;
            }

            const scenePrompt = scenePromptInput.value.trim();
            if (!scenePrompt) {
                showError('Please enter a scene description');
                return;
            }

            // Disable button and show loading
            generateBtn.disabled = true;
            generateBtn.innerHTML = '‚ú® Generating<span class="loading"></span>';
            hideError();
            codeOutput.textContent = '// Generating code...';

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'AI4ArtsEd p5.js Test'
                    },
                    body: JSON.stringify({
                        model: modelSelect.value,
                        messages: [
                            {
                                role: 'system',
                                content: systemPromptInput.value
                            },
                            {
                                role: 'user',
                                content: scenePrompt
                            }
                        ],
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                }

                const data = await response.json();
                const generatedCode = data.choices[0].message.content;

                // Clean up code (remove markdown if present)
                state.generatedCode = generatedCode
                    .replace(/```javascript\n/g, '')
                    .replace(/```js\n/g, '')
                    .replace(/```\n/g, '')
                    .replace(/```$/g, '')
                    .trim();

                codeOutput.textContent = state.generatedCode;
                runBtn.disabled = false;
                copyBtn.disabled = false;

                // Auto-run the code
                runCode();

            } catch (error) {
                showError(`Error: ${error.message}`);
                codeOutput.textContent = '// Error generating code';
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '‚ú® Generate p5.js Code';
            }
        }

        function runCode() {
            if (!state.generatedCode) return;

            const html = `
<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"><\/script>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #f7fafc;
        }
        canvas {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <script>
        try {
            ${state.generatedCode}
        } catch (error) {
            document.body.innerHTML = '<div style="color: red; padding: 20px; font-family: monospace;">Error: ' + error.message + '<\/div>';
            console.error('p5.js error:', error);
        }
    <\/script>
</body>
</html>`;

            preview.srcdoc = html;
        }

        function copyToClipboard() {
            navigator.clipboard.writeText(state.generatedCode).then(() => {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                showError('Failed to copy to clipboard');
            });
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            errorDiv.style.display = 'none';
        }
    </script>
</body>
</html>
