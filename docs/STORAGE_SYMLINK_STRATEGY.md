# Storage Symlink Strategy - Unified Dev/Prod Storage

**Date:** 2025-11-15
**Purpose:** Eliminate 404 errors from dual storage by sharing single storage location
**Deployment Context:** Internet-facing via Cloudflare tunnel for research phase (multiple courses with students on iPad Pro 10"). WiFi-only deployment planned for post-research end use case.

---

## Problem Statement

**Current situation:**
- Dev backend: `/home/joerissen/ai/ai4artsed_webserver/exports/json/` (256 runs)
- Prod backend: `/opt/ai4artsed-production/exports/json/` (229 runs)
- **Total:** 485 runs split across two locations

**404 Error Scenario:**
1. Image generated by Backend A → Saved to Storage A
2. Image requested from Backend B → Looks in Storage B
3. **Result:** 404 error (file doesn't exist in Storage B)

**User Requirements:**
- 1 stable production backend running
- Ability to dev on same system simultaneously
- Internet access via Cloudflare tunnel (CURRENT: research phase with multiple courses)
- Multiple participants accessing via internet (iPad Pro 10" primary device)
- Future: WiFi-only deployment after research project ends
- NO nginx (using Vite proxy + Cloudflare)

---

## Solution: Symlink Shared Storage

### Option A: Dev → Prod Symlink (RECOMMENDED)

**Make dev use production storage:**

```bash
# 1. Stop all backends
./stop_all.sh

# 2. Backup dev storage (just in case)
sudo mv /home/joerissen/ai/ai4artsed_webserver/exports \
        /home/joerissen/ai/ai4artsed_webserver/exports.backup

# 3. Create symlink: dev → prod
sudo ln -s /opt/ai4artsed-production/exports \
           /home/joerissen/ai/ai4artsed_webserver/exports

# 4. Verify symlink
ls -la /home/joerissen/ai/ai4artsed_webserver/exports
# Should show: exports -> /opt/ai4artsed-production/exports

# 5. Test both backends can write
cd /home/joerissen/ai/ai4artsed_webserver/devserver
python3 -c "from pathlib import Path; print(Path('exports/json').resolve())"
# Should output: /opt/ai4artsed-production/exports/json

cd /opt/ai4artsed-production/devserver
python3 -c "from pathlib import Path; print(Path('exports/json').resolve())"
# Should output: /opt/ai4artsed-production/exports/json
```

**Why dev → prod:**
- Production is the canonical/stable version
- Dev points to prod (clearer semantics)
- Backups/exports happen from prod location

---

### Option B: Prod → Dev Symlink (Alternative)

**Make prod use dev storage:**

```bash
# 1. Stop all backends
./stop_all.sh

# 2. Backup prod storage
sudo mv /opt/ai4artsed-production/exports \
        /opt/ai4artsed-production/exports.backup

# 3. Create symlink: prod → dev
sudo ln -s /home/joerissen/ai/ai4artsed_webserver/exports \
           /opt/ai4artsed-production/exports

# 4. Verify and test (same as Option A)
```

**Why prod → dev:**
- Dev is actively used (256 vs 229 runs)
- Easier access for development
- No sudo needed for dev work

---

### Option C: Both → Shared Location (Most Clean)

**Create dedicated shared storage:**

```bash
# 1. Stop all backends
./stop_all.sh

# 2. Create shared storage location
sudo mkdir -p /var/ai4artsed/storage/exports/json
sudo chown -R joerissen:joerissen /var/ai4artsed/storage

# 3. Merge existing data (choose most recent)
cp -r /opt/ai4artsed-production/exports/json/* /var/ai4artsed/storage/exports/json/
cp -r /home/joerissen/ai/ai4artsed_webserver/exports/json/* /var/ai4artsed/storage/exports/json/

# 4. Backup originals
sudo mv /opt/ai4artsed-production/exports /opt/ai4artsed-production/exports.backup
sudo mv /home/joerissen/ai/ai4artsed_webserver/exports /home/joerissen/ai/ai4artsed_webserver/exports.backup

# 5. Create symlinks from both locations
sudo ln -s /var/ai4artsed/storage/exports /opt/ai4artsed-production/exports
sudo ln -s /var/ai4artsed/storage/exports /home/joerissen/ai/ai4artsed_webserver/exports
```

**Why shared location:**
- Clearest semantics (neither is "canonical")
- Standard Linux practice (`/var` for variable data)
- Easier backup strategy (one location)
- Better permissions management

---

## Recommended Approach: **Option A** (Dev → Prod Symlink)

**Rationale:**
1. **Production is canonical** - Stable, deployed version
2. **Simpler** - One symlink, clear direction
3. **Your use case** - 1 stable prod + dev capability
4. **WiFi deployment** - Prod is what users access

---

## Implementation Steps

### 1. Pre-Flight Checks

```bash
# Check what's running
ps aux | grep "python3.*server.py" | grep -v grep
# Expected: Only one backend (currently dev on port 17801)

# Check current storage sizes
du -sh /home/joerissen/ai/ai4artsed_webserver/exports/
du -sh /opt/ai4artsed-production/exports/

# Check write permissions
touch /opt/ai4artsed-production/exports/test_write && rm /opt/ai4artsed-production/exports/test_write
# Should succeed
```

### 2. Execute Symlink (Option A)

```bash
# Stop everything
cd /home/joerissen/ai/ai4artsed_webserver
./stop_all.sh

# Backup dev exports (safety)
sudo cp -r exports exports.backup_$(date +%Y%m%d_%H%M%S)

# Remove dev exports, create symlink
sudo rm -rf exports
sudo ln -s /opt/ai4artsed-production/exports exports

# Verify
ls -la exports
# Should show: exports -> /opt/ai4artsed-production/exports

cd exports/json
pwd -P
# Should show: /opt/ai4artsed-production/exports/json
```

### 3. Start Services

```bash
# Start production backend
cd /opt/ai4artsed-production/devserver
./start_backend_fg.sh
# Or if using systemd:
sudo systemctl start ai4artsed-production.service

# In another terminal, start frontend
cd /home/joerissen/ai/ai4artsed_webserver/public/ai4artsed-frontend
npm run dev
```

### 4. Test Image Generation

```bash
# Generate test image via frontend
# Or via curl:
curl -X POST http://localhost:17801/api/schema/pipeline/execute \
  -H "Content-Type: application/json" \
  -d '{
    "schema": "sd35_large",
    "input_text": "a red apple on a table",
    "execution_mode": "eco",
    "output_config": "sd35_large"
  }'

# Check storage
ls -la /opt/ai4artsed-production/exports/json/ | tail -5
# Should show newly created run directory

# Verify both paths resolve to same location
ls -la /home/joerissen/ai/ai4artsed_webserver/exports/json/ | tail -5
# Should show SAME directories (via symlink)
```

### 5. Test Image Display

1. Open frontend: http://localhost:5173
2. Generate image
3. Verify image displays immediately (no 404)
4. Check browser console for errors (should be none)

---

## Development Workflow After Symlink

### Running Dev Backend Alongside Prod

**DON'T run both on same port!** Use different ports:

```bash
# Prod backend (port 17801 - stable, for users)
cd /opt/ai4artsed-production/devserver
./start_backend_fg.sh  # Uses port 17801

# Dev backend (port 17802 - for testing)
cd /home/joerissen/ai/ai4artsed_webserver/devserver
# Edit config.py temporarily:
# PORT = 17802

python3 server.py  # Runs on 17802

# Test dev backend:
curl http://localhost:17802/api/schema/info
```

**Both backends share same storage via symlink → No 404s!**

### Frontend Development

```bash
# Frontend always proxies to port 17801 (prod backend)
cd /home/joerissen/ai/ai4artsed_webserver/public/ai4artsed-frontend
npm run dev  # Port 5173

# If testing with dev backend (17802), temporarily edit vite.config.ts:
# proxy: { '/api': { target: 'http://localhost:17802' } }
```

---

## Rollback Plan

If symlink causes issues:

```bash
# 1. Stop everything
./stop_all.sh

# 2. Remove symlink
sudo rm /home/joerissen/ai/ai4artsed_webserver/exports

# 3. Restore backup
sudo mv /home/joerissen/ai/ai4artsed_webserver/exports.backup_TIMESTAMP \
        /home/joerissen/ai/ai4artsed_webserver/exports

# 4. Restart dev backend
cd /home/joerissen/ai/ai4artsed_webserver/devserver
python3 server.py
```

---

## Deployment Context: Internet-Facing Research System

**Current Setup (Research Phase):**
```
Multiple Course Participants (Internet, iPad Pro 10")
  ↓
Cloudflare Tunnel (lab.ai4artsed.org → localhost:5173/17801)
  ↓
┌─────────────────────────────────────┐
│  Vite Dev Server (port 5173)       │
│    - Serves Vue frontend            │
│    - Proxies /api → localhost:17801 │
└─────────────────────────────────────┘
  ↓ (proxy)
┌─────────────────────────────────────┐
│  Flask Backend (port 17801)         │
│    - Production or Dev backend      │
│    - Reads from exports/json/       │
└─────────────────────────────────────┘
  ↓ (via symlink)
┌─────────────────────────────────────┐
│  Shared Storage                     │
│  /opt/ai4artsed-production/exports/ │
│     (or shared /var/ai4artsed/)     │
└─────────────────────────────────────┘
```

**No nginx needed** - Vite proxy + Cloudflare tunnel handle routing

**Internet access:** ACTIVE during research phase (multiple courses), WiFi-only planned for post-research deployment

---

## Benefits of Symlink Solution

### ✅ Solves 404 Errors
- Single storage location
- Both backends read/write same files
- No race condition or load balancing issues

### ✅ Enables Dev + Prod Simultaneously
- Run prod backend on port 17801 (stable, for users)
- Run dev backend on port 17802 (testing)
- Both share storage via symlink

### ✅ Simple & Maintainable
- One line change (create symlink)
- No configuration drift
- Easy to rollback

### ✅ Fits Your Deployment
- Internet-facing via Cloudflare (research phase with multiple courses)
- iPad Pro 10" optimized interface
- No nginx complexity
- Single machine dev + production capability

---

## Verification Checklist

After implementing symlink:

- [ ] Symlink created and points to correct location
- [ ] Both paths resolve to same directory (`pwd -P` test)
- [ ] Backend starts successfully
- [ ] Frontend starts successfully
- [ ] Image generation works (curl test)
- [ ] Image displays in frontend (no 404)
- [ ] Browser console clean (no errors)
- [ ] Storage writes to correct location
- [ ] Dev backend can run on alt port (if needed)
- [ ] Backup exists (rollback ready)

---

## Next Steps

1. **Execute Option A** (Dev → Prod symlink)
2. **Test thoroughly** (checklist above)
3. **Update start scripts** if needed (document new workflow)
4. **Consider systemd** for prod backend (auto-start on boot)

---

## Files Modified

**After implementing symlink:**
- `/home/joerissen/ai/ai4artsed_webserver/exports` → symlink to `/opt/ai4artsed-production/exports`
- `devserver/config.py` - No changes needed (relative paths work)
- `vite.config.ts` - No changes needed (proxies to 17801)

---

**Decision:** Implement Option A (Dev → Prod symlink) to solve 404s while enabling dev+prod workflow.
